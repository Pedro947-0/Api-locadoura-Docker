name: CI/CD Docker build and Test

on:
  push:
    branches: ["main"]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do código
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Preparar .env com secrets para o docker-compose
        run: |
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" > .env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env

      - name: ✅ Login no Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: 🐋 Subir ambiente com Docker Compose (build)
        run: |
          docker-compose up -d --build

      - name: ⏱️ Aguardar Postgres ficar pronto (pg_isready)
        run: |
          echo "Aguardando o Postgres..."
          retries=0
          until docker-compose exec -T postgres-db pg_isready -U postgres -d locadora-db >/dev/null 2>&1 || [ $retries -ge 60 ]; do
            sleep 2
            retries=$((retries+1))
            echo "Tentativa $retries..."
          done
          if [ $retries -ge 60 ]; then
            echo "Postgres não ficou pronto em tempo." >&2
            echo "--- Últimos logs do DB ---"
            docker-compose logs postgres-db --tail=200 || true
            exit 1
          fi

      - name: 🩺 Verificar status dos contêineres e logs
        run: |
          echo "--- Status dos Contêineres ---"
          docker-compose ps
          echo "--- Logs do Banco de Dados (últimas 200 linhas) ---"
          docker-compose logs postgres-db --tail=200 || true
          echo "--- Logs da API (últimas 200 linhas) ---"
          docker-compose logs api-spring --tail=200 || true

      - name: 📞 Realizar teste de saúde na API
        run: |
          # Altere o endpoint se sua aplicação expor outro (por exemplo /actuator/health)
          curl --fail http://localhost:8080/actuator/health

      - name: 🛑 Parar os contêineres após teste
        if: always()
        run: |
          docker-compose down -v

      - name: 🚀 Build e Push da imagem para o Docker Hub
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/locadora-veiculos:latest
