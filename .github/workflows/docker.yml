name: CI/CD Docker build and Test

on:
  push:
    branches: ["main"]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Preparar .env com secrets para o docker-compose
        run: |
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" > .env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env

      - name: âœ… Login no Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ðŸ‹ Subir ambiente com Docker Compose (build)
        run: |
          docker-compose up -d --build

      - name: â±ï¸ Aguardar Postgres ficar pronto (pg_isready)
        run: |
          echo "Aguardando o Postgres..."
          retries=0
          until docker-compose exec -T postgres-db pg_isready -U postgres -d locadora-db >/dev/null 2>&1 || [ $retries -ge 60 ]; do
            sleep 2
            retries=$((retries+1))
            echo "Tentativa $retries..."
          done
          if [ $retries -ge 60 ]; then
            echo "Postgres nÃ£o ficou pronto em tempo." >&2
            echo "--- Ãšltimos logs do DB ---"
            docker-compose logs postgres-db --tail=200 || true
            exit 1
          fi

      - name: ðŸ©º Verificar status dos contÃªineres e logs
        run: |
          echo "--- Status dos ContÃªineres ---"
          docker-compose ps
          echo "--- Logs do Banco de Dados (Ãºltimas 200 linhas) ---"
          docker-compose logs postgres-db --tail=200 || true
          echo "--- Logs da API (Ãºltimas 200 linhas) ---"
          docker-compose logs api-spring --tail=200 || true

      - name: ðŸ“ž Realizar teste de saÃºde na API
        run: |
          # Altere o endpoint se sua aplicaÃ§Ã£o expor outro (por exemplo /actuator/health)
          curl --fail http://localhost:8080/actuator/health

      - name: ðŸ›‘ Parar os contÃªineres apÃ³s teste
        if: always()
        run: |
          docker-compose down -v

      - name: ðŸš€ Build e Push da imagem para o Docker Hub
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/locadora-veiculos:latest
